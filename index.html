<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vexora</title>
    <link rel="icon" type="image/x-icon" href="https://i.ibb.co/qMdzn35L/Gemini-Generated-Image-h82pl4h82pl4h82p.png">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Custom scrollbar styling for a cleaner look */
        #chat-container::-webkit-scrollbar {
            width: 8px;
        }
        #chat-container::-webkit-scrollbar-track {
            background: #111827;
            border-radius: 10px;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background: #06b6d4;
            border-radius: 10px;
        }
        #chat-container::-webkit-scrollbar-thumb:hover {
            background: #0891b2;
        }

        /* Message bubble styling */
        .chat-message-left, .chat-message-right {
            max-width: 80%;
            transition: opacity 0.3s ease, height 0.3s ease, padding 0.3s ease, margin-bottom 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease, filter 0.3s ease;
            animation: fadeIn 0.3s ease-out;
            position: relative;
            border-radius: 10px;
        }

        .message-selected {
            transform: scale(1.02);
            box-shadow: 0 0 15px #00ffff, 0 0 5px #00ffff;
            z-index: 999;
        }

        .chat-message-left { margin-right: auto; }
        .chat-message-right { margin-left: auto; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
        }

        .modal-overlay-blur {
            background-color: rgba(0, 0, 0, 0.7);
            opacity: 0;
        }

        .reaction-selector {
            position: fixed;
            z-index: 100;
            box-shadow: 0 0 10px #00ffff;
        }

        .unselectable {
            user-select: none;
        }

        /* ðŸŒˆðŸŒˆðŸŒˆ THEME VARIABLES ðŸŒˆðŸŒˆðŸŒˆ */
        .theme-dark {
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --text-main: #ffffff;
            --accent: #00ffff;
        }

        .theme-light {
            --bg-main: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #000000;
            --accent: #4c1d95;
        }

        .theme-purple {
            --bg-main: #1a002b;
            --bg-card: #2a0047;
            --text-main: #e9d8fd;
            --accent: #b832ff;
        }

        /* Apply theme */
        body {
            background: var(--bg-main) !important;
            color: var(--text-main) !important;
        }
        #main-chat-wrapper {
            background: var(--bg-card) !important;
            border-color: var(--accent) !important;
        }
        #chat-container {
            background: var(--bg-card) !important;
        }
        button, input {
            border-color: var(--accent) !important;
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'pigeon-dark': '#083344',
                        'pigeon-main': '#4c1d95',
                        'pigeon-light': '#00FFFF',
                        'bg-slate': '#1f2937',
                        'bg-deep': '#0f172a',
                    }
                }
            }
        }
    </script>
</head>

<body class="theme-dark min-h-screen font-sans flex flex-col items-center justify-center overflow-y-hidden">

    <div id="main-chat-wrapper"
        class="w-full max-w-2xl shadow-2xl rounded-xl p-6 sm:p-8 border transform m-auto flex flex-col h-[95vh] relative">

        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-4">
            <div class="flex items-center space-x-3 mb-2 sm:mb-0">
                <img src="pigeon-bird.png" alt="Pigeon Logo" class="w-16 h-16"/>
                <img src="logo.png" alt="Pigeon Network Logo" class="h-16"/>
            </div>

            <div class="flex items-center space-x-3">
                <span id="current-username-display"
                    class="text-lg font-semibold bg-gray-700 py-1 px-3 rounded-md hidden"></span>

                <!-- ðŸŒˆ Theme Button (Placed EXACTLY where you wanted â€” Option 1) -->
                <button id="theme-toggle"
                    class="px-3 py-2 text-sm bg-gray-700 text-pigeon-light rounded-md hover:bg-gray-600 transition border border-pigeon-light/50">
                    Theme
                </button>

                <button id="auth-button"
                    class="px-3 py-2 text-sm bg-gray-700 text-pigeon-light rounded-md hover:bg-gray-600 transition border border-pigeon-light/50">
                    Sign In
                </button>
            </div>
        </header>
                <div id="chat-container"
            class="p-4 mb-6 border rounded-xl shadow-inner overflow-y-auto flex-grow unselectable">
            <div class="text-center text-gray-500 italic p-10" id="initial-message">
                Sign in or continue as a guest to chat.
            </div>
        </div>

        <div id="message-section" class="flex space-x-3 hidden">
            <input type="text" id="message-input" placeholder="Type your message..."
                class="flex-grow p-3 border rounded-md bg-gray-800 text-gray-100 placeholder-gray-400">
            <button id="send-button"
                class="w-[6rem] inline-flex items-center justify-center py-3 bg-pigeon-main text-pigeon-light font-bold rounded-md border border-pigeon-light/50">
                <span id="send-text">Send</span>
                <svg id="loading-spinner"
                    class="animate-spin h-5 w-5 text-white hidden"
                    xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10"
                        stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 
                        0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 
                        3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </div>

        <div id="status-message"
            class="mt-4 text-sm text-center font-medium p-2 rounded-md hidden"></div>
    </div>

    <!-- Blur Overlay -->
    <div id="reaction-blur-overlay"
        class="modal-overlay-blur fixed inset-0 z-40 hidden"></div>

    <!-- Reaction Selector -->
    <div id="reaction-selector"
        class="reaction-selector bg-gray-800 p-1.5 rounded-full border hidden">
        <div class="flex space-x-1.5">

            <button data-reaction="heart" class="reaction-btn p-0.5 rounded-full hover:bg-gray-700">
                <img src="heart.png" class="w-6 h-6">
            </button>

            <button data-reaction="bad" class="reaction-btn p-0.5 rounded-full hover:bg-gray-700">
                <img src="bad.png" class="w-6 h-6">
            </button>

            <button data-reaction="cry" class="reaction-btn p-0.5 rounded-full hover:bg-gray-700">
                <img src="cry.png" class="w-6 h-6">
            </button>

            <button data-reaction="flip" class="reaction-btn p-0.5 rounded-full hover:bg-gray-700">
                <img src="flip.png" class="w-6 h-6">
            </button>

            <button data-reaction="copy" class="reaction-btn p-0.5 rounded-full text-pigeon-light">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6"
                    fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M8 7v6a2 2 0 002 2h6M8 7H6a2 
                        2 0 00-2 2v10a2 2 0 002 2h10a2 
                        2 0 002-2v-2M8 7h6M8 7V5a2 
                        2 0 012-2h6a2 2 0 012 2v2M8 
                        7H6M8 7v6"></path>
                </svg>
            </button>

            <button id="close-reaction-menu-btn"
                class="reaction-btn p-0.5 rounded-full text-gray-400 hover:text-red-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6"
                    fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>

        </div>
    </div>

    <!-- Sign In / Register Modal -->
    <div id="username-modal"
        class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div id="modal-content"
            class="bg-gray-900 rounded-xl shadow-2xl w-full max-w-sm p-8 border-t-4 border-pigeon-light opacity-0 scale-95">

            <h2 id="modal-title" class="text-3xl font-bold text-pigeon-light mb-6 text-center">
                Welcome!
            </h2>

            <label for="modal-username-input"
                class="block text-lg font-medium mb-2">Username:</label>
            <input type="text" id="modal-username-input"
                class="w-full p-3 border rounded-md bg-gray-800 text-gray-100 mb-4">

            <label for="modal-password-input"
                class="block text-lg font-medium mb-2">Password:</label>
            <input type="password" id="modal-password-input"
                class="w-full p-3 border rounded-md bg-gray-800 text-gray-100 mb-4">

            <div id="verify-password-group" class="hidden">
                <label for="modal-verify-password-input"
                    class="block text-lg font-medium mb-2">Verify Password:</label>
                <input type="password" id="modal-verify-password-input"
                    class="w-full p-3 border rounded-md bg-gray-800 text-gray-100 mb-8">
            </div>

            <div id="modal-error-message"
                class="text-sm text-red-400 bg-red-900 border border-red-600 p-2 rounded-md mb-4 hidden"></div>

            <button id="modal-action-button"
                class="w-full py-3 bg-green-700 text-white font-bold text-lg rounded-md mb-3 border border-green-500">
                Sign In
            </button>

            <button id="guest-continue-button"
                class="w-full py-3 bg-gray-700 text-pigeon-light font-bold text-lg rounded-md mb-6 border border-pigeon-light/50">
                Continue as Guest
            </button>

            <p class="text-center text-gray-400 text-sm">
                <a href="#" id="modal-toggle-link"
                    class="text-pigeon-light font-medium">Need an account? Sign Up.</a>
            </p>
        </div>
    </div>

    <!-- START OF SCRIPT -->
    <script>
        /* ========= THEME SWITCHER ========= */
        const themes = ["theme-dark", "theme-light", "theme-purple"];
        let currentThemeIndex = 0;

        const savedTheme = localStorage.getItem("vexora-theme");
        if (savedTheme && themes.includes(savedTheme)) {
            document.body.classList.add(savedTheme);
            currentThemeIndex = themes.indexOf(savedTheme);
        } else {
            document.body.classList.add("theme-dark");
        }

        document.getElementById("theme-toggle").addEventListener("click", () => {
            document.body.classList.remove(themes[currentThemeIndex]);
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            document.body.classList.add(themes[currentThemeIndex]);
            localStorage.setItem("vexora-theme", themes[currentThemeIndex]);
        });

        /* ========= THE REST OF YOUR CHAT LOGIC CONTINUES BELOW ========= */
        /* ====== ORIGINAL CHAT SYSTEM CONSTANTS ====== */
        const CHAT_INTERVAL = 3000;
        const REGISTERED_USERNAME_KEY = 'chat_registered_username';
        const MIN_USERNAME_LENGTH = 3;
        const MIN_PASSWORD_LENGTH = 6;
        const ADMIN_USERNAME = 'Mikeywikey';
        const ALPHANUMERIC_REGEX = /^[a-zA-Z0-9_-]+$/;

        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzAkQl4I1NyC93ea2CmDMsxdiyJJ195QRF4GiLqf0CdIXrF-P3m3yr_MFpo-1Llik4T/exec';

        let currentUsername = '';
        let isGuest = false;
        let lastMessageCount = 0;
        let pollingInterval = null;
        let isSigningUp = false;
        let currentConfirmAction = null;
        let isProcessingAction = false;
        let tempMessageElement = null;
        let lastSentMessageContent = '';
        let isInitialLoad = true;

        let reactionTimer = null;
        const LONG_PRESS_DURATION = 500;
        let currentMessageForReaction = null;

        const mainChatWrapper = document.getElementById('main-chat-wrapper');
        const chatHeader = document.querySelector('header');
        const currentUsernameDisplay = document.getElementById('current-username-display');
        const authButton = document.getElementById('auth-button');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const sendText = document.getElementById('send-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const chatContainer = document.getElementById('chat-container');
        const messageSection = document.getElementById('message-section');
        const initialMessage = document.getElementById('initial-message');
        const statusMessage = document.getElementById('status-message');
        const reactionSelector = document.getElementById('reaction-selector');
        const reactionBlurOverlay = document.getElementById('reaction-blur-overlay');

        const usernameModal = document.getElementById('username-modal');
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        const modalUsernameInput = document.getElementById('modal-username-input');
        const modalPasswordInput = document.getElementById('modal-password-input');
        const modalVerifyPasswordInput = document.getElementById('modal-verify-password-input');
        const verifyPasswordGroup = document.getElementById('verify-password-group');
        const modalActionButton = document.getElementById('modal-action-button');
        const modalToggleLink = document.getElementById('modal-toggle-link');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const guestContinueButton = document.getElementById('guest-continue-button');

        /* ====== UTILITY FUNCTIONS ====== */

        function generateGuestId() {
            const num = Math.floor(100000 + Math.random() * 900000);
            return `Vexorian(${num})`;
        }

        function scrollToBottom() {
            window.requestAnimationFrame(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
                setTimeout(() => {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }, 300);
            });
        }

        function disableChatActions(disabled) {
            messageInput.disabled = disabled;
            sendButton.disabled = disabled;
            if (disabled) hideReactionSelector();
        }

        function displayError(msg) {
            statusMessage.innerHTML = msg;
            statusMessage.className =
                "mt-4 text-sm text-center font-medium p-2 rounded-md bg-red-900 border border-red-600";
            statusMessage.classList.remove("hidden");

            clearTimeout(currentConfirmAction);
            currentConfirmAction = setTimeout(() => {
                statusMessage.classList.add("hidden");
            }, 4000);
        }

        function displayStatus(msg) {
            statusMessage.innerHTML = msg;
            statusMessage.className =
                "mt-4 text-sm text-center font-medium p-2 rounded-md bg-green-900 border border-green-600";
            statusMessage.classList.remove("hidden");

            clearTimeout(currentConfirmAction);
            currentConfirmAction = setTimeout(() => {
                statusMessage.classList.add("hidden");
            }, 3000);
        }

        function apiRequest(method, formData = null) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open(method, SCRIPT_URL);

                xhr.onload = function () {
                    try {
                        const text = xhr.responseText.trim();
                        const json = JSON.parse(text);
                        json.success ? resolve(json) : reject(new Error(json.error));
                    } catch (e) {
                        reject(new Error("Malformed or empty server response"));
                    }
                };

                xhr.onerror = () => reject(new Error("Connection failed"));

                if (method === "POST") xhr.send(formData);
                else xhr.send();
            });
        }

        /* ====== POLLING ====== */
        function stopChatPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
        }

        function startChatPolling() {
            stopChatPolling();
            fetchMessages();
            pollingInterval = setInterval(fetchMessages, CHAT_INTERVAL);
        }

        /* ====== MODAL ====== */

        function toggleModalState(isSignup) {
            isSigningUp = isSignup;

            if (isSignup) {
                modalTitle.textContent = "Register New Account";
                modalActionButton.textContent = "Sign Up";
                verifyPasswordGroup.classList.remove("hidden");
                guestContinueButton.classList.add("hidden");
            } else {
                modalTitle.textContent = "Sign In";
                modalActionButton.textContent = "Sign In";
                verifyPasswordGroup.classList.add("hidden");
                guestContinueButton.classList.remove("hidden");
            }
        }

        function showModal() {
            modalUsernameInput.value = localStorage.getItem(REGISTERED_USERNAME_KEY) || "";
            modalPasswordInput.value = "";
            modalVerifyPasswordInput.value = "";
            usernameModal.classList.remove("hidden");

            setTimeout(() => {
                modalContent.style.opacity = "1";
                modalContent.style.transform = "scale(1)";
            }, 10);
        }

        function hideModal() {
            modalContent.style.opacity = "0";
            modalContent.style.transform = "scale(0.95)";
            setTimeout(() => {
                usernameModal.classList.add("hidden");
            }, 300);
        }

        async function handleModalSave() {
            const username = modalUsernameInput.value.trim();
            const password = modalPasswordInput.value.trim();
            const verifyPassword = modalVerifyPasswordInput.value.trim();

            if (!username || !password) {
                modalErrorMessage.textContent = "Username and password required.";
                modalErrorMessage.classList.remove("hidden");
                return;
            }

            if (isSigningUp && password !== verifyPassword) {
                modalErrorMessage.textContent = "Passwords do not match.";
                modalErrorMessage.classList.remove("hidden");
                return;
            }

            const formData = new FormData();
            formData.append("action", isSigningUp ? "SIGNUP" : "SIGNIN");
            formData.append("username", username);
            formData.append("password", password);

            try {
                const res = await apiRequest("POST", formData);
                handleSuccessfulAuth(res.displayUsername || username, false);
            } catch (err) {
                modalErrorMessage.textContent = err.message;
                modalErrorMessage.classList.remove("hidden");
            }
        }

        function handleSuccessfulAuth(username, guest) {
            currentUsername = username;
            isGuest = guest;

            if (!guest) {
                localStorage.setItem(REGISTERED_USERNAME_KEY, username);
            }

            hideModal();
            updateUIForUsername();
            startChatPolling();
        }

        /* ====== REACTIONS ====== */

        function hideReactionSelector() {
            reactionSelector.classList.add("hidden");
            reactionBlurOverlay.classList.add("hidden");
        }

        async function handleReaction(reaction) {
            hideReactionSelector();

            const msgId = reactionSelector.getAttribute("data-message-id");
            if (!msgId) return;

            const formData = new FormData();
            formData.append("action", "REACT_MESSAGE");
            formData.append("id", msgId);
            formData.append("nickname", currentUsername);
            formData.append("reaction", reaction);

            try {
                await apiRequest("POST", formData);
                fetchMessages();
            } catch {}
        }

        /* ====== MESSAGES ====== */

        function createMessageElement(msg) {
            const isMine = msg.nickname === currentUsername;
            const messageElement = document.createElement("div");

            messageElement.className =
                `${isMine ? "chat-message-right bg-pigeon-main text-white" : "chat-message-left bg-gray-800 text-gray-100"}
                 flex flex-col p-3 rounded-xl mb-4 border border-gray-700`;

            messageElement.setAttribute("data-message-id", msg.id);
            messageElement.setAttribute("data-nickname", msg.nickname);

            messageElement.innerHTML = `
                <div class="flex items-baseline space-x-2 mb-1">
                    <span class="font-bold">${msg.nickname}</span>
                    <span class="text-xs text-gray-400">${msg.timestamp}</span>
                </div>
                <div class="whitespace-pre-wrap">${msg.message}</div>
            `;

            return messageElement;
        }

        function renderMessages(messages) {
            chatContainer.innerHTML = "";

            messages.forEach(msg => {
                const el = createMessageElement(msg);
                chatContainer.appendChild(el);
            });

            scrollToBottom();
        }

        async function fetchMessages() {
            try {
                const res = await apiRequest("GET");
                renderMessages(res.data);
            } catch {}
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;

            messageInput.value = "";
            scrollToBottom();

            const formData = new FormData();
            formData.append("action", "SEND");
            formData.append("nickname", currentUsername);
            formData.append("message", text);

            try {
                await apiRequest("POST", formData);
                fetchMessages();
            } catch (err) {
                displayError("Failed to send message.");
            }
        }

        /* ====== UI CONTROL ====== */

        function updateUIForUsername() {
            if (!currentUsername) return;

            currentUsernameDisplay.textContent = isGuest
                ? `Guest: ${currentUsername}`
                : `ID: ${currentUsername}`;

            currentUsernameDisplay.classList.remove("hidden");
            authButton.textContent = "Sign Out";
            messageSection.classList.remove("hidden");
        }

        /* ====== EVENT LISTENERS ====== */

        authButton.onclick = () => {
            if (currentUsername && !isGuest) {
                currentUsername = "";
                isGuest = true;
                currentUsernameDisplay.classList.add("hidden");
                authButton.textContent = "Sign In";
                messageSection.classList.add("hidden");
                showModal();
            } else {
                showModal();
            }
        };

        guestContinueButton.onclick = () => {
            handleSuccessfulAuth(generateGuestId(), true);
        };

        modalToggleLink.onclick = e => {
            e.preventDefault();
            toggleModalState(!isSigningUp);
        };

        modalActionButton.onclick = handleModalSave;
        sendButton.onclick = sendMessage;

        messageInput.addEventListener("keypress", e => {
            if (e.key === "Enter") sendMessage();
        });

        reactionSelector.addEventListener("click", e => {
            const btn = e.target.closest(".reaction-btn");
            if (!btn) return;
            const type = btn.getAttribute("data-reaction");
            handleReaction(type);
        });

        /* ====== AUTO LOGIN GUEST ON LOAD ====== */

        document.addEventListener("DOMContentLoaded", () => {
            const saved = localStorage.getItem(REGISTERED_USERNAME_KEY);

            if (saved) {
                handleSuccessfulAuth(saved, false);
            } else {
                handleSuccessfulAuth(generateGuestId(), true);
            }
        });

    </script>

</body>
</html>

